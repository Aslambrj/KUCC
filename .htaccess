# --- React SPA routing & sensible defaults ---

# Turn on rewriting
RewriteEngine On

# If your app lives at the main domain document root, keep this as "/".
# If your app is in a subfolder (e.g., example.com/app), set: RewriteBase /app/
RewriteBase /

# Avoid content negotiation weirdness
Options -MultiViews

# Let real files/folders pass through (e.g., /assets/*, /.well-known/*)
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Everything else â†’ index.html (client-side router handles it)
RewriteRule ^ index.html [L]

# Serve index.html for 404s too (nicer SPA behavior)
ErrorDocument 404 /index.html

# --- Performance: caching & compression ---

<IfModule mod_expires.c>
  ExpiresActive On
  # default short-ish
  ExpiresDefault "access plus 1 hour"
  # HTML should not be cached aggressively
  ExpiresByType text/html "access plus 0 seconds"
  # Static assets (hashed filenames) can be cached long
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType application/json "access plus 7 days"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType application/wasm "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
  # Make HTML always revalidate (prevents users seeing stale shell)
  <FilesMatch "\.html?$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>

  # Long cache for versioned static files
  <FilesMatch "\.(js|css|png|jpg|jpeg|gif|svg|webp|ico|ttf|otf|woff|woff2|wasm)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Allow fonts/SVG to be used across origins (prevents CORS errors with CDNs)
  <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|svg)$">
    Header set Access-Control-Allow-Origin "*"
  </FilesMatch>

  # Basic security hardening (safe defaults)
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Gzip / Brotli (whichever your server supports)
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css application/javascript application/json image/svg+xml
</IfModule>
<IfModule mod_brotli.c>
  BrotliCompressionQuality 5
  AddOutputFilterByType BROTLI_COMPRESS text/plain text/html text/xml text/css application/javascript application/json image/svg+xml
</IfModule>

# Correct MIME for WASM if you ship it
AddType application/wasm wasm
